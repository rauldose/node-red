@* ============================================================
   Syncfusion Blazor Tab Component Wrapper
   Replaces custom tabs with Syncfusion Tab
   ============================================================ *@

<SfTab @ref="TabRef" CssClass="@Class" SelectedItem="@GetActiveTabIndex()">
    <TabAnimationSettings>
        <TabAnimationPrevious Effect="AnimationEffect.None" />
        <TabAnimationNext Effect="AnimationEffect.None" />
    </TabAnimationSettings>
    <TabEvents Selected="@OnTabSelectedInternal" />
    <TabItems>
        @foreach (var tab in TabItems)
        {
            <TabItem Disabled="@tab.Disabled">
                <ChildContent>
                    <TabHeader>
                        @if (!string.IsNullOrEmpty(tab.Icon))
                        {
                            <i class="fa @tab.Icon"></i>
                        }
                        <span>@tab.Label</span>
                    </TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <div></div>
                </ContentTemplate>
            </TabItem>
        }
        @if (Addable && OnTabAdd.HasDelegate)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader>
                        <div @onclick="AddTab" class="add-tab-button">
                            <i class="fa fa-plus"></i>
                        </div>
                    </TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <div></div>
                </ContentTemplate>
            </TabItem>
        }
    </TabItems>
</SfTab>

<style>
    .add-tab-button {
        cursor: pointer;
        padding: 4px 8px;
    }
    .add-tab-button:hover {
        background-color: #f0f0f0;
    }
</style>

@code {
    [Parameter] public List<TabItem> TabItems { get; set; } = new();
    [Parameter] public string? ActiveTab { get; set; }
    [Parameter] public EventCallback<string> ActiveTabChanged { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter] public bool Addable { get; set; } = false;
    [Parameter] public EventCallback OnTabAdd { get; set; }
    [Parameter] public EventCallback<TabItem> OnTabClose { get; set; }
    [Parameter] public EventCallback<TabItem> OnTabSelected { get; set; }

    private SfTab? TabRef;

    private int GetActiveTabIndex()
    {
        if (string.IsNullOrEmpty(ActiveTab))
            return 0;
        
        var index = TabItems.FindIndex(t => t.Id == ActiveTab);
        return index >= 0 ? index : 0;
    }

    private async Task OnTabSelectedInternal(SelectEventArgs args)
    {
        if (args.SelectedIndex < TabItems.Count)
        {
            var tab = TabItems[args.SelectedIndex];
            if (!tab.Disabled)
            {
                ActiveTab = tab.Id;
                await ActiveTabChanged.InvokeAsync(tab.Id);
                await OnTabSelected.InvokeAsync(tab);
            }
        }
    }

    private async Task AddTab()
    {
        await OnTabAdd.InvokeAsync();
    }

    /// <summary>
    /// Add a tab. Translated from addTab() in tabs.js
    /// </summary>
    public void AddTabItem(TabItem tab)
    {
        TabItems.Add(tab);
        StateHasChanged();
    }

    /// <summary>
    /// Remove a tab. Translated from removeTab() in tabs.js
    /// </summary>
    public void RemoveTab(string id)
    {
        TabItems.RemoveAll(t => t.Id == id);
        StateHasChanged();
    }

    /// <summary>
    /// Activate a tab. Translated from activateTab() in tabs.js
    /// </summary>
    public async Task ActivateTab(string id)
    {
        var tab = TabItems.FirstOrDefault(t => t.Id == id);
        if (tab != null)
        {
            var index = TabItems.IndexOf(tab);
            if (TabRef != null)
            {
                await TabRef.SelectAsync(index);
            }
            ActiveTab = id;
            await ActiveTabChanged.InvokeAsync(id);
            await OnTabSelected.InvokeAsync(tab);
        }
    }

    public class TabItem
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Label { get; set; } = "";
        public string? Icon { get; set; }
        public bool Closable { get; set; } = false;
        public bool Disabled { get; set; } = false;
    }
}
