@* Syncfusion Blazor TextBox Component Wrapper for Search *@
@* Replaces custom searchBox with Syncfusion TextBox *@

<SfTextBox @bind-Value="@Value"
           Placeholder="@Placeholder"
           CssClass="@($"red-ui-searchBox {Class}")"
           ShowClearButton="true"
           Input="@OnValueChanged">
    <TextBoxPrefixIcon>fa fa-search</TextBoxPrefixIcon>
</SfTextBox>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Search...";
    [Parameter] public string? Class { get; set; }
    [Parameter] public EventCallback<string> OnSearch { get; set; }

    private async Task OnValueChanged(InputEventArgs args)
    {
        Value = args.Value;
        await ValueChanged.InvokeAsync(Value);
        await OnSearch.InvokeAsync(Value);
    }

    public void Clear()
    {
        Value = "";
        StateHasChanged();
    }
}

        cursor: pointer;
        padding: 4px;
    }
    .red-ui-searchBox-clear:hover {
        color: #000;
    }
</style>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Search...";
    [Parameter] public string? Class { get; set; }
    [Parameter] public int Delay { get; set; } = 300;
    [Parameter] public EventCallback<string> OnSearch { get; set; }
    [Parameter] public EventCallback OnClear { get; set; }

    private System.Timers.Timer? _debounceTimer;

    protected override void OnInitialized()
    {
        _debounceTimer = new System.Timers.Timer(Delay);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (s, e) =>
        {
            await InvokeAsync(async () =>
            {
                await OnSearch.InvokeAsync(Value);
            });
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
        await ValueChanged.InvokeAsync(Value);
    }

    private async Task Clear()
    {
        Value = "";
        await ValueChanged.InvokeAsync(Value);
        await OnClear.InvokeAsync();
        await OnSearch.InvokeAsync(Value);
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await Clear();
        }
        else if (e.Key == "Enter")
        {
            _debounceTimer?.Stop();
            await OnSearch.InvokeAsync(Value);
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
