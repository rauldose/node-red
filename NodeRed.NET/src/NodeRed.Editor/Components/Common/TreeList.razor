@* Syncfusion Blazor TreeView Component Wrapper *@
@* Replaces custom treeList with Syncfusion TreeView *@

@typeparam TItem where TItem : class

<SfTreeView @ref="TreeRef" 
            TValue="TreeNode<TItem>"
            CssClass="@Class"
            AllowDragAndDrop="false"
            ShowCheckBox="false">
    <TreeViewFieldsSettings DataSource="@Items" 
                           Id="Id"
                           Text="Label"
                           IconCss="Icon"
                           Child="Children"
                           Expanded="Expanded" />
    <TreeViewEvents TValue="TreeNode<TItem>" 
                   NodeSelected="@OnNodeSelected"
                   NodeExpanded="@OnNodeExpanded"
                   NodeCollapsed="@OnNodeCollapsed" />
</SfTreeView>

@code {
    [Parameter] public IList<TreeNode<TItem>>? Items { get; set; }
    [Parameter] public RenderFragment<TItem>? ItemTemplate { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter] public bool AutoExpand { get; set; } = false;
    [Parameter] public EventCallback<TreeNode<TItem>> OnItemSelected { get; set; }
    [Parameter] public EventCallback<TreeNode<TItem>> OnItemExpanded { get; set; }
    [Parameter] public EventCallback<TreeNode<TItem>> OnItemCollapsed { get; set; }

    private SfTreeView<TreeNode<TItem>>? TreeRef;

    private async Task OnNodeSelected(NodeSelectEventArgs args)
    {
        var nodeData = await GetNodeData(args.NodeData.Id);
        if (nodeData != null)
        {
            await OnItemSelected.InvokeAsync(nodeData);
        }
    }

    private async Task OnNodeExpanded(NodeExpandEventArgs args)
    {
        var nodeData = await GetNodeData(args.NodeData.Id);
        if (nodeData != null)
        {
            await OnItemExpanded.InvokeAsync(nodeData);
        }
    }

    private async Task OnNodeCollapsed(NodeExpandEventArgs args)
    {
        var nodeData = await GetNodeData(args.NodeData.Id);
        if (nodeData != null)
        {
            await OnItemCollapsed.InvokeAsync(nodeData);
        }
    }

    private Task<TreeNode<TItem>?> GetNodeData(string id)
    {
        if (Items == null) return Task.FromResult<TreeNode<TItem>?>(null);
        
        TreeNode<TItem>? FindNode(IEnumerable<TreeNode<TItem>> nodes, string nodeId)
        {
            foreach (var node in nodes)
            {
                if (node.Id == nodeId) return node;
                if (node.Children != null)
                {
                    var found = FindNode(node.Children, nodeId);
                    if (found != null) return found;
                }
            }
            return null;
        }
        
        return Task.FromResult(FindNode(Items, id));
    }

    public async Task ExpandAll()
    {
        if (TreeRef != null)
        {
            await TreeRef.ExpandAllAsync();
        }
    }

    public async Task CollapseAll()
    {
        if (TreeRef != null)
        {
            await TreeRef.CollapseAllAsync();
        }
    }

    public class TreeNode<T> where T : class
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Label { get; set; } = "";
        public string? Icon { get; set; }
        public string? IconColor { get; set; }
        public string? Badge { get; set; }
        public bool Expanded { get; set; } = false;
        public bool Selected { get; set; } = false;
        public T? Data { get; set; }
        public List<TreeNode<T>>? Children { get; set; }
    }
}
