@* Syncfusion Blazor Tooltip Component Wrapper *@
@* Replaces custom popover with Syncfusion Tooltip *@

<SfTooltip @ref="TooltipRef" 
           Content="@Content" 
           Target="@Target"
           Position="@GetPosition()"
           IsSticky="@IsSticky"
           ShowTipPointer="true"
           CssClass="red-ui-popover">
    @if (ChildContent != null)
    {
        @ChildContent
    }
</SfTooltip>

@code {
    [Parameter] public string? Content { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string Target { get; set; } = "";
    [Parameter] public string Direction { get; set; } = "bottom"; // top, bottom, left, right
    [Parameter] public bool IsSticky { get; set; } = false;
    [Parameter] public double X { get; set; }
    [Parameter] public double Y { get; set; }
    
    private SfTooltip? TooltipRef;
    
    private Position GetPosition()
    {
        return Direction.ToLower() switch
        {
            "top" => Position.TopCenter,
            "bottom" => Position.BottomCenter,
            "left" => Position.LeftCenter,
            "right" => Position.RightCenter,
            _ => Position.BottomCenter
        };
    }
    
    public async Task Show()
    {
        if (TooltipRef != null)
        {
            await TooltipRef.OpenAsync();
        }
    }
    
    public async Task Hide()
    {
        if (TooltipRef != null)
        {
            await TooltipRef.CloseAsync();
        }
    }
    
    public async Task SetPosition(double x, double y)
    {
        X = x;
        Y = y;
        StateHasChanged();
    }
}

    .red-ui-popover-content {
        padding: 10px 15px;
    }
</style>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string? Content { get; set; }
    [Parameter] public string Direction { get; set; } = "bottom";
    [Parameter] public bool Interactive { get; set; } = false;
    [Parameter] public int AutoClose { get; set; } = 0;

    public bool IsVisible { get; private set; }
    public double X { get; private set; }
    public double Y { get; private set; }

    private System.Timers.Timer? _autoCloseTimer;

    /// <summary>
    /// Show the popover at specified position.
    /// Translated from show() in popover.js
    /// </summary>
    public void Show(double x, double y)
    {
        X = x;
        Y = y;
        IsVisible = true;
        
        if (AutoClose > 0)
        {
            _autoCloseTimer?.Dispose();
            _autoCloseTimer = new System.Timers.Timer(AutoClose);
            _autoCloseTimer.AutoReset = false;
            _autoCloseTimer.Elapsed += (s, e) =>
            {
                InvokeAsync(() =>
                {
                    Hide();
                    StateHasChanged();
                });
            };
            _autoCloseTimer.Start();
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Hide the popover.
    /// Translated from hide() in popover.js
    /// </summary>
    public void Hide()
    {
        IsVisible = false;
        _autoCloseTimer?.Stop();
        StateHasChanged();
    }

    /// <summary>
    /// Set content.
    /// </summary>
    public void SetContent(string content)
    {
        Content = content;
        StateHasChanged();
    }

    public void Dispose()
    {
        _autoCloseTimer?.Dispose();
    }
}
