@* ============================================================
   SOURCE: packages/node_modules/@node-red/editor-client/src/js/ui/common/popover.js
   ============================================================
   TRANSLATION: JavaScript popover to Blazor component
   ============================================================ *@

<div class="red-ui-popover-container @(IsVisible ? "visible" : "")" 
     style="left: @(X)px; top: @(Y)px;">
    @if (IsVisible)
    {
        <div class="red-ui-popover @Direction">
            <div class="red-ui-popover-arrow"></div>
            <div class="red-ui-popover-content">
                @if (ChildContent != null)
                {
                    @ChildContent
                }
                else
                {
                    @Content
                }
            </div>
        </div>
    }
</div>

<style>
    .red-ui-popover-container {
        position: fixed;
        z-index: 3000;
        pointer-events: none;
        display: none;
    }
    .red-ui-popover-container.visible {
        display: block;
        pointer-events: auto;
    }
    .red-ui-popover {
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-width: 300px;
    }
    .red-ui-popover-arrow {
        position: absolute;
        width: 10px;
        height: 10px;
        background: white;
        border: 1px solid #ccc;
        transform: rotate(45deg);
    }
    .red-ui-popover.bottom .red-ui-popover-arrow {
        top: -6px;
        left: 50%;
        margin-left: -5px;
        border-right: none;
        border-bottom: none;
    }
    .red-ui-popover.top .red-ui-popover-arrow {
        bottom: -6px;
        left: 50%;
        margin-left: -5px;
        border-left: none;
        border-top: none;
    }
    .red-ui-popover.left .red-ui-popover-arrow {
        right: -6px;
        top: 50%;
        margin-top: -5px;
        border-left: none;
        border-bottom: none;
    }
    .red-ui-popover.right .red-ui-popover-arrow {
        left: -6px;
        top: 50%;
        margin-top: -5px;
        border-right: none;
        border-top: none;
    }
    .red-ui-popover-content {
        padding: 10px 15px;
    }
</style>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string? Content { get; set; }
    [Parameter] public string Direction { get; set; } = "bottom";
    [Parameter] public bool Interactive { get; set; } = false;
    [Parameter] public int AutoClose { get; set; } = 0;

    public bool IsVisible { get; private set; }
    public double X { get; private set; }
    public double Y { get; private set; }

    private System.Timers.Timer? _autoCloseTimer;

    /// <summary>
    /// Show the popover at specified position.
    /// Translated from show() in popover.js
    /// </summary>
    public void Show(double x, double y)
    {
        X = x;
        Y = y;
        IsVisible = true;
        
        if (AutoClose > 0)
        {
            _autoCloseTimer?.Dispose();
            _autoCloseTimer = new System.Timers.Timer(AutoClose);
            _autoCloseTimer.AutoReset = false;
            _autoCloseTimer.Elapsed += (s, e) =>
            {
                InvokeAsync(() =>
                {
                    Hide();
                    StateHasChanged();
                });
            };
            _autoCloseTimer.Start();
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Hide the popover.
    /// Translated from hide() in popover.js
    /// </summary>
    public void Hide()
    {
        IsVisible = false;
        _autoCloseTimer?.Stop();
        StateHasChanged();
    }

    /// <summary>
    /// Set content.
    /// </summary>
    public void SetContent(string content)
    {
        Content = content;
        StateHasChanged();
    }

    public void Dispose()
    {
        _autoCloseTimer?.Dispose();
    }
}
