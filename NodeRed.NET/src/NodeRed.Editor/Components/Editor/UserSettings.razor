@* ============================================================
   SOURCE: packages/node_modules/@node-red/editor-client/src/js/ui/userSettings.js
   ============================================================
   TRANSLATION: JavaScript userSettings module to Blazor component
   ============================================================ *@

@using NodeRed.Editor.Services
@inject EditorState State

<div class="red-ui-settings-dialog @(IsVisible ? "visible" : "")">
    @if (IsVisible)
    {
        <div class="red-ui-settings-overlay" @onclick="Hide"></div>
        <div class="red-ui-settings-panel">
            <div class="red-ui-settings-header">
                <span class="red-ui-settings-title">User Settings</span>
                <button class="red-ui-settings-close" @onclick="Hide">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="red-ui-settings-tabs">
                @foreach (var tab in _tabs)
                {
                    <div class="red-ui-settings-tab @(ActiveTab == tab.Id ? "active" : "")"
                         @onclick="() => ActiveTab = tab.Id">
                        <i class="fa @tab.Icon"></i>
                        <span>@tab.Label</span>
                    </div>
                }
            </div>
            
            <div class="red-ui-settings-content">
                @switch (ActiveTab)
                {
                    case "view":
                        <div class="red-ui-settings-section">
                            <h4>View</h4>
                            
                            <div class="red-ui-settings-row">
                                <label>Grid</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.ShowGrid" />
                                        <span>Show grid</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Grid Size</label>
                                <div class="red-ui-settings-field">
                                    <input type="number" @bind="_settings.GridSize" min="5" max="50" />
                                    <span class="red-ui-settings-hint">pixels</span>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Snap to Grid</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.SnapToGrid" />
                                        <span>Enable snap to grid</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Node Status</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.ShowNodeStatus" />
                                        <span>Show node status</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Zoom</label>
                                <div class="red-ui-settings-field">
                                    <input type="range" @bind="_settings.Zoom" min="25" max="200" step="5" />
                                    <span>@(_settings.Zoom)%</span>
                                </div>
                            </div>
                        </div>
                        break;

                    case "editor":
                        <div class="red-ui-settings-section">
                            <h4>Code Editor</h4>
                            
                            <div class="red-ui-settings-row">
                                <label>Theme</label>
                                <div class="red-ui-settings-field">
                                    <select @bind="_settings.EditorTheme">
                                        <option value="ace/theme/github">Light (GitHub)</option>
                                        <option value="ace/theme/monokai">Dark (Monokai)</option>
                                        <option value="ace/theme/tomorrow">Tomorrow</option>
                                        <option value="ace/theme/twilight">Twilight</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Font Size</label>
                                <div class="red-ui-settings-field">
                                    <select @bind="_settings.EditorFontSize">
                                        <option value="10">10px</option>
                                        <option value="12">12px</option>
                                        <option value="14">14px</option>
                                        <option value="16">16px</option>
                                        <option value="18">18px</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Line Numbers</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.ShowLineNumbers" />
                                        <span>Show line numbers</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Auto-complete</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.AutoComplete" />
                                        <span>Enable auto-complete</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        break;

                    case "keyboard":
                        <div class="red-ui-settings-section">
                            <h4>Keyboard Shortcuts</h4>
                            
                            <div class="red-ui-keyboard-shortcuts">
                                @foreach (var shortcut in _shortcuts)
                                {
                                    <div class="red-ui-settings-row">
                                        <label>@shortcut.Label</label>
                                        <div class="red-ui-settings-field">
                                            <code>@shortcut.Key</code>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        break;

                    case "other":
                        <div class="red-ui-settings-section">
                            <h4>Other Settings</h4>
                            
                            <div class="red-ui-settings-row">
                                <label>Deploy Mode</label>
                                <div class="red-ui-settings-field">
                                    <select @bind="_settings.DeployMode">
                                        <option value="full">Full</option>
                                        <option value="flows">Modified Flows</option>
                                        <option value="nodes">Modified Nodes</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Deploy Confirmation</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.ConfirmDeploy" />
                                        <span>Confirm deploy when modified nodes not deployed</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="red-ui-settings-row">
                                <label>Auto-save</label>
                                <div class="red-ui-settings-field">
                                    <label class="red-ui-checkbox">
                                        <input type="checkbox" @bind="_settings.AutoSave" />
                                        <span>Auto-save editor changes</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        break;
                }
            </div>
            
            <div class="red-ui-settings-footer">
                <button class="red-ui-button" @onclick="ResetToDefaults">Reset to Defaults</button>
                <div class="red-ui-settings-footer-spacer"></div>
                <button class="red-ui-button" @onclick="Hide">Cancel</button>
                <button class="red-ui-button primary" @onclick="Save">Save</button>
            </div>
        </div>
    }
</div>

<style>
    .red-ui-settings-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
    }
    .red-ui-settings-dialog.visible {
        display: block;
    }
    .red-ui-settings-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
    }
    .red-ui-settings-panel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 4px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .red-ui-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
    }
    .red-ui-settings-title {
        font-size: 16px;
        font-weight: 500;
    }
    .red-ui-settings-close {
        background: none;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        color: #666;
    }
    .red-ui-settings-close:hover {
        color: #000;
    }
    .red-ui-settings-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        background: #f5f5f5;
    }
    .red-ui-settings-tab {
        padding: 10px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 2px solid transparent;
    }
    .red-ui-settings-tab:hover {
        background: #eee;
    }
    .red-ui-settings-tab.active {
        background: white;
        border-bottom-color: #8e0000;
    }
    .red-ui-settings-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    .red-ui-settings-section h4 {
        margin: 0 0 15px 0;
        color: #666;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .red-ui-settings-row {
        display: flex;
        align-items: center;
        padding: 10px 0;
    }
    .red-ui-settings-row > label {
        width: 150px;
        color: #666;
    }
    .red-ui-settings-field {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .red-ui-settings-field input[type="number"],
    .red-ui-settings-field select {
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    .red-ui-settings-field input[type="range"] {
        flex: 1;
    }
    .red-ui-settings-hint {
        font-size: 12px;
        color: #888;
    }
    .red-ui-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    .red-ui-keyboard-shortcuts code {
        background: #f0f0f0;
        padding: 3px 8px;
        border-radius: 3px;
        font-family: monospace;
    }
    .red-ui-settings-footer {
        display: flex;
        padding: 15px 20px;
        border-top: 1px solid #ddd;
        gap: 10px;
    }
    .red-ui-settings-footer-spacer {
        flex: 1;
    }
    .red-ui-button {
        padding: 8px 16px;
        border: 1px solid #ccc;
        background: #f5f5f5;
        border-radius: 3px;
        cursor: pointer;
    }
    .red-ui-button:hover {
        background: #eee;
    }
    .red-ui-button.primary {
        background: #8e0000;
        color: white;
        border-color: #8e0000;
    }
    .red-ui-button.primary:hover {
        background: #a00000;
    }
</style>

@code {
    private UserSettingsData _settings = new();
    private List<SettingsTab> _tabs = new()
    {
        new() { Id = "view", Label = "View", Icon = "fa-eye" },
        new() { Id = "editor", Label = "Editor", Icon = "fa-code" },
        new() { Id = "keyboard", Label = "Keyboard", Icon = "fa-keyboard-o" },
        new() { Id = "other", Label = "Other", Icon = "fa-cog" }
    };
    private List<KeyboardShortcut> _shortcuts = new()
    {
        new() { Label = "Copy", Key = "Ctrl+C" },
        new() { Label = "Paste", Key = "Ctrl+V" },
        new() { Label = "Cut", Key = "Ctrl+X" },
        new() { Label = "Undo", Key = "Ctrl+Z" },
        new() { Label = "Redo", Key = "Ctrl+Shift+Z" },
        new() { Label = "Select All", Key = "Ctrl+A" },
        new() { Label = "Delete", Key = "Delete" },
        new() { Label = "Search", Key = "Ctrl+F" },
        new() { Label = "Deploy", Key = "Ctrl+D" },
        new() { Label = "Export", Key = "Ctrl+E" },
        new() { Label = "Import", Key = "Ctrl+I" },
        new() { Label = "Group Selection", Key = "Ctrl+Shift+G" }
    };

    public bool IsVisible { get; private set; }
    public string ActiveTab { get; private set; } = "view";

    /// <summary>
    /// Show the user settings dialog.
    /// Translated from show() in userSettings.js
    /// </summary>
    public void Show()
    {
        LoadSettings();
        IsVisible = true;
        ActiveTab = "view";
        StateHasChanged();
    }

    /// <summary>
    /// Hide the user settings dialog.
    /// </summary>
    public void Hide()
    {
        IsVisible = false;
        StateHasChanged();
    }

    private void LoadSettings()
    {
        // Load from state or defaults
        _settings = new UserSettingsData
        {
            ShowGrid = true,
            GridSize = 20,
            SnapToGrid = true,
            ShowNodeStatus = true,
            Zoom = 100,
            EditorTheme = "ace/theme/github",
            EditorFontSize = 14,
            ShowLineNumbers = true,
            AutoComplete = true,
            DeployMode = "full",
            ConfirmDeploy = true,
            AutoSave = false
        };
    }

    private void Save()
    {
        // Save settings to state
        State.Events.Emit("settings:changed", _settings);
        Hide();
    }

    private void ResetToDefaults()
    {
        _settings = new UserSettingsData();
        StateHasChanged();
    }

    private class SettingsTab
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string Icon { get; set; } = "";
    }

    private class KeyboardShortcut
    {
        public string Label { get; set; } = "";
        public string Key { get; set; } = "";
    }

    private class UserSettingsData
    {
        public bool ShowGrid { get; set; } = true;
        public int GridSize { get; set; } = 20;
        public bool SnapToGrid { get; set; } = true;
        public bool ShowNodeStatus { get; set; } = true;
        public int Zoom { get; set; } = 100;
        public string EditorTheme { get; set; } = "ace/theme/github";
        public int EditorFontSize { get; set; } = 14;
        public bool ShowLineNumbers { get; set; } = true;
        public bool AutoComplete { get; set; } = true;
        public string DeployMode { get; set; } = "full";
        public bool ConfirmDeploy { get; set; } = true;
        public bool AutoSave { get; set; } = false;
    }
}
