@* ============================================================
   SOURCE: packages/node_modules/@node-red/editor-client/src/js/ui/contextMenu.js
   ============================================================
   Context menu component for right-click actions
   ============================================================ *@

@inject IJSRuntime JS

<div id="red-ui-context-menu" 
     class="red-ui-context-menu @(IsVisible ? "visible" : "hide")"
     style="left: @(X)px; top: @(Y)px; @(IsVisible ? "" : "display: none;")">
    @if (Items.Count > 0)
    {
        <ul>
            @foreach (var item in Items)
            {
                @if (item.IsSeparator)
                {
                    <li class="red-ui-context-menu-separator"></li>
                }
                else
                {
                    <li class="red-ui-context-menu-item @(item.Disabled ? "disabled" : "")" 
                        @onclick="() => HandleItemClick(item)"
                        @onclick:stopPropagation="true">
                        <span class="red-ui-context-menu-icon">
                            @if (!string.IsNullOrEmpty(item.Icon))
                            {
                                <i class="fa @item.Icon"></i>
                            }
                        </span>
                        <span class="red-ui-context-menu-label">@item.Label</span>
                        @if (!string.IsNullOrEmpty(item.Shortcut))
                        {
                            <span class="red-ui-context-menu-shortcut">@item.Shortcut</span>
                        }
                    </li>
                }
            }
        </ul>
    }
</div>

<style>
    .red-ui-context-menu {
        position: fixed;
        z-index: 10000;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        min-width: 180px;
        padding: 4px 0;
        font-size: 13px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    .red-ui-context-menu.hide {
        display: none;
    }
    
    .red-ui-context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    
    .red-ui-context-menu-item {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        cursor: pointer;
        color: #333;
        transition: background-color 0.1s;
    }
    
    .red-ui-context-menu-item:hover {
        background-color: #f0f0f0;
    }
    
    .red-ui-context-menu-item.disabled {
        color: #999;
        cursor: default;
    }
    
    .red-ui-context-menu-item.disabled:hover {
        background-color: transparent;
    }
    
    .red-ui-context-menu-icon {
        width: 20px;
        text-align: center;
        margin-right: 8px;
        color: #666;
    }
    
    .red-ui-context-menu-label {
        flex: 1;
    }
    
    .red-ui-context-menu-shortcut {
        margin-left: 20px;
        color: #999;
        font-size: 11px;
    }
    
    .red-ui-context-menu-separator {
        height: 1px;
        background: #ddd;
        margin: 4px 8px;
    }
</style>

@code {
    private bool IsVisible = false;
    private double X = 0;
    private double Y = 0;
    private List<ContextMenuItem> Items = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Add click handler to close menu when clicking outside
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('click', function(e) {
                    var menu = document.getElementById('red-ui-context-menu');
                    if (menu && !menu.contains(e.target)) {
                        menu.classList.add('hide');
                        menu.style.display = 'none';
                    }
                });
            ");
        }
    }

    public void Show(double x, double y, List<ContextMenuItem> items)
    {
        X = x;
        Y = y;
        Items = items;
        IsVisible = true;
        StateHasChanged();
    }

    public void Hide()
    {
        IsVisible = false;
        Items.Clear();
        StateHasChanged();
    }

    private void HandleItemClick(ContextMenuItem item)
    {
        if (!item.Disabled)
        {
            item.OnClick?.Invoke();
            Hide();
        }
    }

    public class ContextMenuItem
    {
        public string Label { get; set; } = "";
        public string? Icon { get; set; }
        public string? Shortcut { get; set; }
        public bool Disabled { get; set; }
        public bool IsSeparator { get; set; }
        public Action? OnClick { get; set; }
    }
}
