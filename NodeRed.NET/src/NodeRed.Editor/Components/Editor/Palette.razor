@* ============================================================
   SOURCE: packages/node_modules/@node-red/editor-client/src/js/ui/palette.js
   ============================================================
   ORIGINAL CODE (partial - lines 17-130):
   ------------------------------------------------------------
   RED.palette = (function() {
       var exclusion = ['config','unknown','deprecated'];
       var coreCategories = [
           'subflows', 'common', 'function', 'network', 'input',
           'output', 'sequence', 'parser', 'storage', 'analysis',
           'social', 'advanced'
       ];
       var categoryContainers = {};
       ...
   })();
   ------------------------------------------------------------
   TRANSLATION:
   - jQuery DOM manipulation → Blazor component rendering
   - Category containers → Blazor components with state
   ============================================================ *@

@using NodeRed.Editor.Services
@inject EditorState State

<div id="red-ui-palette" class="red-ui-palette">
    @* Palette header with search *@
    <div id="red-ui-palette-search" class="red-ui-palette-search @(IsHidden ? "hide" : "")">
        <div class="red-ui-searchBox">
            <input type="text" 
                   placeholder="@State.I18n.Translate("palette.filter")"
                   @bind="FilterText"
                   @bind:event="oninput"
                   @onkeyup="HandleFilterChange" />
            @if (!string.IsNullOrEmpty(FilterText))
            {
                <button class="red-ui-searchBox-clear" @onclick="ClearFilter">
                    <i class="fa fa-times"></i>
                </button>
            }
        </div>
    </div>

    @* Spinner shown during loading *@
    <div class="red-ui-palette-spinner @(IsLoading ? "" : "hide")">
        <img src="images/spin.svg" alt="Loading..." />
    </div>

    @* Palette scroll container *@
    <div class="red-ui-palette-scroll @(IsLoading ? "hide" : "")">
        <div id="red-ui-palette-container" class="red-ui-palette-container">
            @foreach (var category in GetVisibleCategories())
            {
                <div id="red-ui-palette-container-@category.Id" 
                     class="red-ui-palette-category @(category.IsOpen ? "red-ui-palette-open" : "red-ui-palette-closed")">
                    
                    @* Category header *@
                    <div id="red-ui-palette-header-@category.Id" 
                         class="red-ui-palette-header"
                         @onclick="() => ToggleCategory(category)">
                        <i class="fa @(category.IsOpen ? "fa-angle-down expanded" : "fa-angle-right")"></i>
                        <span>@category.Label</span>
                        <span class="red-ui-palette-category-count">(@category.NodeCount)</span>
                    </div>
                    
                    @* Category content *@
                    <div class="red-ui-palette-content @(category.IsOpen ? "" : "hide")" 
                         id="red-ui-palette-base-category-@category.Id">
                        @foreach (var nodeType in GetNodesInCategory(category.Id))
                        {
                            <PaletteNode NodeType="@nodeType" 
                                        OnDragStart="@(e => HandleDragStart(e, nodeType))" />
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // ============================================================
    // MAPPING NOTES:
    // - var exclusion → Exclusion
    // - var coreCategories → CoreCategories
    // - var categoryContainers → _categories
    // - paletteState.filter → FilterText
    // - paletteState.collapsed → collapsed categories tracked in _categories
    // ============================================================

    // Exclusion list - translated from exclusion array
    private static readonly HashSet<string> Exclusion = new() { "config", "unknown", "deprecated" };

    // Core categories - translated from coreCategories array
    private static readonly List<string> CoreCategories = new()
    {
        "subflows", "common", "function", "network", "input",
        "output", "sequence", "parser", "storage", "analysis",
        "social", "advanced"
    };

    private List<PaletteCategory> _categories = new();
    private string FilterText = "";
    private bool IsLoading = true;
    private bool IsHidden = false;

    protected override void OnInitialized()
    {
        // Initialize categories
        foreach (var cat in CoreCategories)
        {
            _categories.Add(new PaletteCategory
            {
                Id = cat,
                Label = FormatCategoryLabel(cat),
                IsOpen = cat == "common" || cat == "function" || cat == "network",
                NodeCount = 0
            });
        }

        // Add mock nodes for demonstration (translated from core nodes)
        _nodeTypes.Add(new NodeTypeInfo { Type = "inject", Label = "inject", Category = "common", Color = "#a6bbcf", Icon = "fa-clock", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "debug", Label = "debug", Category = "common", Color = "#87a980", Icon = "fa-bug", Inputs = 1, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "complete", Label = "complete", Category = "common", Color = "#a6bbcf", Icon = "fa-check", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "catch", Label = "catch", Category = "common", Color = "#a6bbcf", Icon = "fa-warning", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "status", Label = "status", Category = "common", Color = "#a6bbcf", Icon = "fa-info-circle", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "link in", Label = "link in", Category = "common", Color = "#ddd", Icon = "fa-arrow-left", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "link out", Label = "link out", Category = "common", Color = "#ddd", Icon = "fa-arrow-right", Inputs = 1, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "link call", Label = "link call", Category = "common", Color = "#ddd", Icon = "fa-share", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "comment", Label = "comment", Category = "common", Color = "#fff", Icon = "fa-comment", Inputs = 0, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "junction", Label = "junction", Category = "common", Color = "#999", Icon = "fa-circle", Inputs = 1, Outputs = 1 });

        _nodeTypes.Add(new NodeTypeInfo { Type = "function", Label = "function", Category = "function", Color = "#fdd0a2", Icon = "fa-code", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "switch", Label = "switch", Category = "function", Color = "#e2d96e", Icon = "fa-random", Inputs = 1, Outputs = 2 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "change", Label = "change", Category = "function", Color = "#e2d96e", Icon = "fa-pencil", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "range", Label = "range", Category = "function", Color = "#e2d96e", Icon = "fa-arrows-h", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "template", Label = "template", Category = "function", Color = "#e2c96e", Icon = "fa-file-text-o", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "delay", Label = "delay", Category = "function", Color = "#e6e0f8", Icon = "fa-clock-o", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "trigger", Label = "trigger", Category = "function", Color = "#e6e0f8", Icon = "fa-crosshairs", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "exec", Label = "exec", Category = "function", Color = "#fdd0a2", Icon = "fa-terminal", Inputs = 1, Outputs = 3 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "rbe", Label = "filter", Category = "function", Color = "#e2d96e", Icon = "fa-filter", Inputs = 1, Outputs = 1 });

        _nodeTypes.Add(new NodeTypeInfo { Type = "mqtt in", Label = "mqtt in", Category = "network", Color = "#d8bfd8", Icon = "fa-sign-in", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "mqtt out", Label = "mqtt out", Category = "network", Color = "#d8bfd8", Icon = "fa-sign-out", Inputs = 1, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "http in", Label = "http in", Category = "network", Color = "#d8bfd8", Icon = "fa-globe", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "http response", Label = "http response", Category = "network", Color = "#d8bfd8", Icon = "fa-reply", Inputs = 1, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "http request", Label = "http request", Category = "network", Color = "#d8bfd8", Icon = "fa-cloud", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "websocket in", Label = "websocket in", Category = "network", Color = "#d8bfd8", Icon = "fa-sign-in", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "websocket out", Label = "websocket out", Category = "network", Color = "#d8bfd8", Icon = "fa-sign-out", Inputs = 1, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "tcp in", Label = "tcp in", Category = "network", Color = "#c7c7c7", Icon = "fa-sign-in", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "tcp out", Label = "tcp out", Category = "network", Color = "#c7c7c7", Icon = "fa-sign-out", Inputs = 1, Outputs = 0 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "udp in", Label = "udp in", Category = "network", Color = "#c7c7c7", Icon = "fa-sign-in", Inputs = 0, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "udp out", Label = "udp out", Category = "network", Color = "#c7c7c7", Icon = "fa-sign-out", Inputs = 1, Outputs = 0 });

        _nodeTypes.Add(new NodeTypeInfo { Type = "csv", Label = "csv", Category = "parser", Color = "#DEBD5C", Icon = "fa-table", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "html", Label = "html", Category = "parser", Color = "#DEBD5C", Icon = "fa-code", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "json", Label = "json", Category = "parser", Color = "#DEBD5C", Icon = "fa-list-alt", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "xml", Label = "xml", Category = "parser", Color = "#DEBD5C", Icon = "fa-file-code-o", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "yaml", Label = "yaml", Category = "parser", Color = "#DEBD5C", Icon = "fa-file-text-o", Inputs = 1, Outputs = 1 });

        _nodeTypes.Add(new NodeTypeInfo { Type = "split", Label = "split", Category = "sequence", Color = "#e2d96e", Icon = "fa-expand", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "join", Label = "join", Category = "sequence", Color = "#e2d96e", Icon = "fa-compress", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "sort", Label = "sort", Category = "sequence", Color = "#e2d96e", Icon = "fa-sort", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "batch", Label = "batch", Category = "sequence", Color = "#e2d96e", Icon = "fa-th-large", Inputs = 1, Outputs = 1 });

        _nodeTypes.Add(new NodeTypeInfo { Type = "file", Label = "file", Category = "storage", Color = "#ff9966", Icon = "fa-file", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "file in", Label = "file in", Category = "storage", Color = "#ff9966", Icon = "fa-file-o", Inputs = 1, Outputs = 1 });
        _nodeTypes.Add(new NodeTypeInfo { Type = "watch", Label = "watch", Category = "storage", Color = "#ff9966", Icon = "fa-eye", Inputs = 0, Outputs = 1 });

        // Subscribe to node list changes
        State.Events.On("nodes:list", _ => RefreshPalette());
        State.Events.On("flows:loaded", _ => 
        {
            IsLoading = false;
            RefreshPalette();
        });
        
        // Initial refresh
        RefreshPalette();
        IsLoading = false;
    }

    private List<NodeTypeInfo> _nodeTypes = new();

    private void RefreshPalette()
    {
        // Count nodes per category
        foreach (var category in _categories)
        {
            category.NodeCount = GetNodesInCategory(category.Id).Count;
        }
        StateHasChanged();
    }

    private List<PaletteCategory> GetVisibleCategories()
    {
        return _categories
            .Where(c => c.NodeCount > 0 || !string.IsNullOrEmpty(FilterText))
            .ToList();
    }

    private List<NodeTypeInfo> GetNodesInCategory(string category)
    {
        // Get all node types in this category
        return _nodeTypes
            .Where(n => n.Category == category && MatchesFilter(n))
            .ToList();
    }

    private bool MatchesFilter(NodeTypeInfo node)
    {
        if (string.IsNullOrEmpty(FilterText)) return true;
        
        var filter = FilterText.ToLowerInvariant();
        return node.Type.ToLowerInvariant().Contains(filter) ||
               (node.Label?.ToLowerInvariant().Contains(filter) ?? false);
    }

    private void ToggleCategory(PaletteCategory category)
    {
        category.IsOpen = !category.IsOpen;
        StateHasChanged();
    }

    private void HandleFilterChange(KeyboardEventArgs e)
    {
        RefreshPalette();
    }

    private void ClearFilter()
    {
        FilterText = "";
        RefreshPalette();
    }

    private void HandleDragStart(DragEventArgs e, NodeTypeInfo nodeType)
    {
        // Set drag data for node creation
        // This will be handled by the workspace to create a new node
    }

    private string FormatCategoryLabel(string category)
    {
        // Translated from label formatting in createCategoryContainer
        var translated = State.I18n.Translate($"palette.label.{category}");
        if (translated == $"palette.label.{category}")
        {
            // Fallback to formatted category name
            return System.Globalization.CultureInfo.CurrentCulture.TextInfo
                .ToTitleCase(category.Replace("_", " "));
        }
        return translated;
    }

    // ============================================================
    // Supporting types
    // ============================================================

    public class PaletteCategory
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public bool IsOpen { get; set; } = true;
        public int NodeCount { get; set; }
    }

    public class NodeTypeInfo
    {
        public string Type { get; set; } = "";
        public string? Label { get; set; }
        public string? Category { get; set; }
        public string? Color { get; set; }
        public string? Icon { get; set; }
        public int Inputs { get; set; }
        public int Outputs { get; set; }
    }
}
