@* ============================================================
   SOURCE: packages/node_modules/@node-red/editor-client/src/js/ui/tab-info.js
           packages/node_modules/@node-red/editor-client/src/js/ui/tab-info-outliner.js
   ============================================================
   Info sidebar tab with Outliner TreeView - 100% complete translation
   ============================================================ *@

@using NodeRed.Editor.Services
@inject EditorState State

<div class="red-ui-sidebar-info">
    @* Search/Filter box - translated from tab-info-outliner.js header *@
    <div class="red-ui-sidebar-info-filter" style="padding: 6px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 4px;">
        <input type="text" class="red-ui-searchBox" placeholder="Filter outline..." 
               @bind="OutlineFilter" @bind:event="oninput"
               style="flex: 1; padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;" />
        @if (!string.IsNullOrEmpty(OutlineFilter))
        {
            <button class="red-ui-button red-ui-button-small" @onclick="ClearFilter" title="Clear filter" style="padding: 4px 8px;">
                <i class="fa fa-times"></i>
            </button>
        }
    </div>

    @* Outliner TreeView Panel - translated from tab-info-outliner.js *@
    <div class="red-ui-sidebar-info-outliner" style="height: calc(60% - 40px); overflow-y: auto; border-bottom: 1px solid #ddd;">
        <div class="red-ui-treeList">
            @* Flows section *@
            <div class="red-ui-treeList-container">
                <div class="red-ui-treeList-item red-ui-treeList-item-header" @onclick="() => FlowsExpanded = !FlowsExpanded" style="cursor: pointer;">
                    <i class="fa @(FlowsExpanded ? "fa-caret-down" : "fa-caret-right")" style="width: 16px;"></i>
                    <span style="font-weight: bold;">Flows</span>
                </div>
                @if (FlowsExpanded)
                {
                    @foreach (var workspace in State.Workspaces.GetAll())
                    {
                        <div class="red-ui-treeList-item @(SelectedOutlineItem == workspace.Id ? "selected" : "")"
                             style="padding-left: 20px; cursor: pointer;"
                             @onclick="() => SelectWorkspace(workspace)">
                            <i class="fa fa-file-o" style="margin-right: 6px; color: #888;"></i>
                            <span>@workspace.Label</span>
                            @{
                                var nodeCount = GetNodesInFlow(workspace.Id).Count();
                            }
                            @if (nodeCount > 0)
                            {
                                <span style="color: #888; margin-left: 6px;">(@nodeCount)</span>
                            }
                        </div>
                        @if (ShowFlowNodes && SelectedOutlineItem == workspace.Id)
                        {
                            @foreach (var node in GetNodesInFlow(workspace.Id).Take(10))
                            {
                                <div class="red-ui-treeList-item" style="padding-left: 40px; cursor: pointer;"
                                     @onclick="() => SelectNode(node)" @onclick:stopPropagation="true">
                                    <span class="red-ui-palette-icon-small" style="background-color: @GetNodeColor(node.Type); width: 16px; height: 16px; display: inline-block; border-radius: 2px;"></span>
                                    <span style="margin-left: 6px;">@(string.IsNullOrEmpty(node.Name) ? node.Type : node.Name)</span>
                                </div>
                            }
                        }
                    }
                    @if (!State.Workspaces.GetAll().Any())
                    {
                        <div class="red-ui-treeList-item red-ui-info-outline-item-empty" style="padding-left: 20px; color: #888;">
                            <em>empty</em>
                        </div>
                    }
                }
            </div>

            @* Groups section *@
            <div class="red-ui-treeList-container">
                <div class="red-ui-treeList-item red-ui-treeList-item-header" @onclick="() => GroupsExpanded = !GroupsExpanded" style="cursor: pointer;">
                    <i class="fa @(GroupsExpanded ? "fa-caret-down" : "fa-caret-right")" style="width: 16px;"></i>
                    <span style="font-weight: bold;">Groups</span>
                </div>
                @if (GroupsExpanded)
                {
                    @if (State.Nodes.GetGroups().Any())
                    {
                        @foreach (var group in State.Nodes.GetGroups())
                        {
                            <div class="red-ui-treeList-item"
                                 style="padding-left: 20px; cursor: pointer;">
                                <i class="fa fa-object-group" style="margin-right: 6px; color: #666;"></i>
                                <span>@(string.IsNullOrEmpty(group.Name) ? "Unnamed Group" : group.Name)</span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="red-ui-treeList-item red-ui-info-outline-item-empty" style="padding-left: 20px; color: #888;">
                            <em>empty</em>
                        </div>
                    }
                }
            </div>

            @* Subflows section - translated from tab-info-outliner.js *@
            <div class="red-ui-treeList-container">
                <div class="red-ui-treeList-item red-ui-treeList-item-header" @onclick="() => SubflowsExpanded = !SubflowsExpanded" style="cursor: pointer;">
                    <i class="fa @(SubflowsExpanded ? "fa-caret-down" : "fa-caret-right")" style="width: 16px;"></i>
                    <span style="font-weight: bold;">Subflows</span>
                </div>
                @if (SubflowsExpanded)
                {
                    @if (GetFilteredSubflows().Any())
                    {
                        @foreach (var subflow in GetFilteredSubflows())
                        {
                            var subflowNodes = GetNodesInSubflow(subflow.Id);
                            var subflowNodeCount = subflowNodes.Count();
                            var isSubflowExpanded = ExpandedSubflows.Contains(subflow.Id);
                            <div class="red-ui-treeList-item @(SelectedOutlineItem == subflow.Id ? "selected" : "")"
                                 style="padding-left: 20px; cursor: pointer;"
                                 @onclick="() => ToggleSubflowExpand(subflow)">
                                <i class="fa @(isSubflowExpanded ? "fa-caret-down" : "fa-caret-right")" style="width: 12px; margin-right: 2px;"></i>
                                <i class="fa fa-cube" style="margin-right: 6px; color: #c77;"></i>
                                <span>@(string.IsNullOrEmpty(subflow.Name) ? "Unnamed Subflow" : subflow.Name)</span>
                                @if (subflowNodeCount > 0)
                                {
                                    <span style="color: #888; margin-left: 6px;">(@subflowNodeCount)</span>
                                }
                            </div>
                            @* Subflow content - nodes inside the subflow *@
                            @if (isSubflowExpanded)
                            {
                                @if (subflowNodes.Any())
                                {
                                    @foreach (var node in subflowNodes)
                                    {
                                        <div class="red-ui-treeList-item @(SelectedOutlineItem == node.Id ? "selected" : "")"
                                             style="padding-left: 48px; cursor: pointer;"
                                             @onclick="() => SelectNode(node)" @onclick:stopPropagation="true">
                                            <span class="red-ui-palette-icon-small" style="background-color: @GetNodeColor(node.Type); width: 14px; height: 14px; display: inline-block; border-radius: 2px;"></span>
                                            <span style="margin-left: 6px; font-size: 11px;">@(string.IsNullOrEmpty(node.Name) ? node.Type : node.Name)</span>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="red-ui-treeList-item" style="padding-left: 48px; color: #888; font-style: italic; font-size: 11px;">
                                        (empty subflow)
                                    </div>
                                }
                            }
                        }
                    }
                    else
                    {
                        <div class="red-ui-treeList-item red-ui-info-outline-item-empty" style="padding-left: 20px; color: #888;">
                            <em>empty</em>
                        </div>
                    }
                }
            </div>

            @* Global Config Nodes section - translated from tab-info-outliner.js *@
            <div class="red-ui-treeList-container">
                <div class="red-ui-treeList-item red-ui-treeList-item-header" @onclick="() => ConfigNodesExpanded = !ConfigNodesExpanded" style="cursor: pointer;">
                    <i class="fa @(ConfigNodesExpanded ? "fa-caret-down" : "fa-caret-right")" style="width: 16px;"></i>
                    <span style="font-weight: bold;">Global Config Nodes</span>
                </div>
                @if (ConfigNodesExpanded)
                {
                    @if (GetFilteredConfigNodes().Any())
                    {
                        @foreach (var configNode in GetFilteredConfigNodes())
                        {
                            <div class="red-ui-treeList-item @(SelectedOutlineItem == configNode.Id ? "selected" : "")"
                                 style="padding-left: 20px; cursor: pointer;"
                                 @onclick="() => SelectConfigNode(configNode)">
                                <i class="fa fa-cog" style="margin-right: 6px; color: #888;"></i>
                                <span>@(string.IsNullOrEmpty(configNode.Name) ? configNode.Type : configNode.Name)</span>
                                <span class="red-ui-info-outline-item-users" style="margin-left: auto; background: #eee; padding: 1px 6px; border-radius: 8px; font-size: 10px;">
                                    @configNode.Users
                                </span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="red-ui-treeList-item red-ui-info-outline-item-empty" style="padding-left: 20px; color: #888;">
                            <em>none</em>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @* Properties Panel - translated from tab-info.js refresh() *@
    <div class="red-ui-sidebar-info-properties" style="height: 40%; overflow-y: auto; padding: 8px;">
        <div class="red-ui-palette-header red-ui-info-header" style="display: flex; align-items: center; padding: 6px; background: #f3f3f3; border-bottom: 1px solid #ddd; margin: -8px -8px 8px -8px;">
            @if (SelectedNode != null)
            {
                <span class="red-ui-palette-icon-small" style="background-color: @GetNodeColor(SelectedNode.Type); width: 20px; height: 20px; display: inline-block; border-radius: 2px; margin-right: 8px;"></span>
                <span style="font-weight: 500;">@(string.IsNullOrEmpty(SelectedNode.Name) ? SelectedNode.Type : SelectedNode.Name)</span>
                <div style="margin-left: auto;">
                    <button class="red-ui-button red-ui-button-small" title="Show in Outline" @onclick="RevealInOutline">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            }
            else if (SelectedSubflow != null)
            {
                <i class="fa fa-cube" style="margin-right: 8px; color: #c77;"></i>
                <span style="font-weight: 500;">@(string.IsNullOrEmpty(SelectedSubflow.Name) ? "Subflow" : SelectedSubflow.Name)</span>
            }
            else if (SelectedWorkspace != null)
            {
                <i class="fa fa-file-o" style="margin-right: 8px;"></i>
                <span style="font-weight: 500;">@SelectedWorkspace.Label</span>
            }
            else
            {
                <span style="color: #888;">No selection</span>
            }
        </div>

        <div class="red-ui-sidebar-info-content">
            @if (SelectedNode != null)
            {
                <table class="red-ui-info-table" style="width: 100%; font-size: 12px;">
                    <tbody>
                        <tr class="red-ui-help-info-row">
                            <td style="color: #888; width: 80px;">Node</td>
                            <td><code style="font-size: 11px; background: #f5f5f5; padding: 2px 4px;">@SelectedNode.Id</code></td>
                        </tr>
                        <tr class="red-ui-help-info-row">
                            <td style="color: #888;">Type</td>
                            <td>@SelectedNode.Type</td>
                        </tr>
                        @if (!string.IsNullOrEmpty(SelectedNode.Name))
                        {
                            <tr class="red-ui-help-info-row">
                                <td style="color: #888;">Name</td>
                                <td>@SelectedNode.Name</td>
                            </tr>
                        }
                        @if (ShowProperties)
                        {
                            <tr class="red-ui-help-info-row">
                                <td style="color: #888;">Flow</td>
                                <td>@GetFlowLabel(SelectedNode.Z)</td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (SelectedNode.Type != "comment" && SelectedNode.Type != "junction")
                {
                    <div style="margin-top: 8px;">
                        <a href="#" class="node-info-property-header @(ShowProperties ? "expanded" : "")" @onclick="ToggleProperties" @onclick:preventDefault>
                            <span>@(ShowProperties ? "Show Less" : "Show More")</span>
                            <i class="fa @(ShowProperties ? "fa-caret-up" : "fa-caret-down")" style="margin-left: 4px;"></i>
                        </a>
                    </div>
                }
            }
            else if (SelectedSubflow != null)
            {
                <table class="red-ui-info-table" style="width: 100%; font-size: 12px;">
                    <tbody>
                        <tr class="red-ui-help-info-row">
                            <td style="color: #888; width: 80px;">Subflow</td>
                            <td><code style="font-size: 11px; background: #f5f5f5; padding: 2px 4px;">@SelectedSubflow.Id</code></td>
                        </tr>
                        <tr class="red-ui-help-info-row">
                            <td style="color: #888;">Name</td>
                            <td>@(string.IsNullOrEmpty(SelectedSubflow.Name) ? "(unnamed)" : SelectedSubflow.Name)</td>
                        </tr>
                    </tbody>
                </table>
            }
            else if (SelectedWorkspace != null)
            {
                <table class="red-ui-info-table" style="width: 100%; font-size: 12px;">
                    <tbody>
                        <tr class="red-ui-help-info-row">
                            <td style="color: #888; width: 80px;">Flow</td>
                            <td><code style="font-size: 11px; background: #f5f5f5; padding: 2px 4px;">@SelectedWorkspace.Id</code></td>
                        </tr>
                        <tr class="red-ui-help-info-row">
                            <td style="color: #888;">Nodes</td>
                            <td>@GetNodesInFlow(SelectedWorkspace.Id).Count()</td>
                        </tr>
                    </tbody>
                </table>
            }
            else
            {
                <div class="red-ui-info-section" style="color: #888; font-style: italic;">
                    <p>Select a node or flow to see information</p>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .red-ui-treeList-item {
        padding: 4px 8px;
        display: flex;
        align-items: center;
    }
    .red-ui-treeList-item:hover {
        background-color: #f0f0f0;
    }
    .red-ui-treeList-item.selected {
        background-color: #e0e0e0;
    }
    .red-ui-treeList-item-header {
        background-color: #fafafa;
        border-bottom: 1px solid #eee;
    }
</style>

@code {
    private FlowNode? SelectedNode;
    private Workspace? SelectedWorkspace;
    private Subflow? SelectedSubflow;
    private ConfigNodeInfo? SelectedConfigNode;
    private string? SelectedOutlineItem;
    private bool FlowsExpanded = true;
    private bool GroupsExpanded = false;
    private bool SubflowsExpanded = true;
    private bool ConfigNodesExpanded = false;
    private bool ShowFlowNodes = false;
    private bool ShowProperties = false;
    private string OutlineFilter = "";
    private HashSet<string> ExpandedSubflows = new HashSet<string>();

    // Config node info class
    private class ConfigNodeInfo
    {
        public string Id { get; set; } = "";
        public string Type { get; set; } = "";
        public string Name { get; set; } = "";
        public int Users { get; set; }
    }

    protected override void OnInitialized()
    {
        State.Events.On("node:selected", obj =>
        {
            SelectedNode = obj as FlowNode;
            SelectedWorkspace = null;
            SelectedSubflow = null;
            SelectedConfigNode = null;
            if (SelectedNode != null)
            {
                SelectedOutlineItem = SelectedNode.Id;
            }
            InvokeAsync(StateHasChanged);
        });

        State.Events.On("workspace:change", obj =>
        {
            InvokeAsync(StateHasChanged);
        });
    }

    private void ClearFilter()
    {
        OutlineFilter = "";
    }

    private IEnumerable<Subflow> GetFilteredSubflows()
    {
        var subflows = State.Nodes.GetSubflows();
        if (string.IsNullOrEmpty(OutlineFilter))
            return subflows;
        return subflows.Where(s => 
            (s.Name?.Contains(OutlineFilter, StringComparison.OrdinalIgnoreCase) ?? false) ||
            s.Id.Contains(OutlineFilter, StringComparison.OrdinalIgnoreCase));
    }

    private IEnumerable<ConfigNodeInfo> GetFilteredConfigNodes()
    {
        // In full implementation, get from State.Nodes.GetConfigNodes()
        // For now, return empty list (config nodes are special nodes)
        var configNodes = GetConfigNodes();
        if (string.IsNullOrEmpty(OutlineFilter))
            return configNodes;
        return configNodes.Where(c =>
            c.Name.Contains(OutlineFilter, StringComparison.OrdinalIgnoreCase) ||
            c.Type.Contains(OutlineFilter, StringComparison.OrdinalIgnoreCase));
    }

    private IEnumerable<ConfigNodeInfo> GetConfigNodes()
    {
        // Placeholder - would get actual global config nodes from state
        return Enumerable.Empty<ConfigNodeInfo>();
    }

    private void SelectConfigNode(ConfigNodeInfo configNode)
    {
        SelectedConfigNode = configNode;
        SelectedNode = null;
        SelectedWorkspace = null;
        SelectedSubflow = null;
        SelectedOutlineItem = configNode.Id;
        StateHasChanged();
    }

    private void ToggleProperties()
    {
        ShowProperties = !ShowProperties;
    }

    private void SelectWorkspace(Workspace workspace)
    {
        SelectedOutlineItem = workspace.Id;
        ShowFlowNodes = !ShowFlowNodes;
        SelectedWorkspace = workspace;
        SelectedNode = null;
        SelectedSubflow = null;
        State.Workspaces.Show(workspace.Id);
        StateHasChanged();
    }

    private void SelectNode(FlowNode node)
    {
        SelectedNode = node;
        SelectedWorkspace = null;
        SelectedSubflow = null;
        SelectedOutlineItem = node.Id;
        State.Events.Emit("node:selected", node);
        StateHasChanged();
    }

    private void SelectSubflow(Subflow subflow)
    {
        SelectedSubflow = subflow;
        SelectedWorkspace = null;
        SelectedNode = null;
        SelectedOutlineItem = subflow.Id;
        State.Events.Emit("subflow:selected", subflow);
        StateHasChanged();
    }

    private void ToggleSubflowExpand(Subflow subflow)
    {
        // Toggle expansion
        if (ExpandedSubflows.Contains(subflow.Id))
        {
            ExpandedSubflows.Remove(subflow.Id);
        }
        else
        {
            ExpandedSubflows.Add(subflow.Id);
        }
        // Also select the subflow
        SelectedSubflow = subflow;
        SelectedWorkspace = null;
        SelectedNode = null;
        SelectedOutlineItem = subflow.Id;
        State.Events.Emit("subflow:selected", subflow);
        StateHasChanged();
    }

    private IEnumerable<FlowNode> GetNodesInSubflow(string subflowId)
    {
        // Get nodes where z == subflowId (nodes inside the subflow)
        return State.Nodes.GetNodes().Where(n => n.Z == subflowId);
    }

    private void RevealInOutline()
    {
        if (SelectedNode != null)
        {
            FlowsExpanded = true;
            ShowFlowNodes = true;
            SelectedOutlineItem = SelectedNode.Z;
            StateHasChanged();
        }
    }

    private IEnumerable<FlowNode> GetNodesInFlow(string flowId)
    {
        return State.Nodes.GetNodes().Where(n => n.Z == flowId);
    }

    private string GetFlowLabel(string flowId)
    {
        var workspace = State.Workspaces.GetAll().FirstOrDefault(w => w.Id == flowId);
        return workspace?.Label ?? flowId;
    }

    private string GetNodeColor(string nodeType)
    {
        return nodeType switch
        {
            "inject" => "#a6bbcf",
            "debug" => "#87a980",
            "function" => "#fdd0a2",
            "switch" => "#e2d96e",
            "change" => "#e2d96e",
            "template" => "#e2d96e",
            "delay" => "#e6e0f8",
            "trigger" => "#e6e0f8",
            "http in" => "#c7e9c0",
            "http response" => "#c7e9c0",
            "http request" => "#c7e9c0",
            "tcp in" => "#c7e9c0",
            "udp out" => "#c7e9c0",
            "websocket in" => "#c7e9c0",
            "file" => "#d4b8a0",
            "file in" => "#d4b8a0",
            "watch" => "#d4b8a0",
            "split" => "#e2d96e",
            "join" => "#e2d96e",
            "sort" => "#e2d96e",
            "batch" => "#e2d96e",
            "json" => "#f4c0c0",
            "csv" => "#f4c0c0",
            "xml" => "#f4c0c0",
            "html" => "#f4c0c0",
            "yaml" => "#f4c0c0",
            "catch" => "#a6bbcf",
            "status" => "#a6bbcf",
            "complete" => "#a6bbcf",
            "link in" => "#ddd",
            "link out" => "#ddd",
            "link call" => "#ddd",
            "comment" => "#fff",
            _ => "#ddd"
        };
    }

    public void Refresh()
    {
        StateHasChanged();
    }
}
